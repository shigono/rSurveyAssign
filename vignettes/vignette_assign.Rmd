---
title: "How to assign subjects"
author: "Shigeru ONO"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{How to assign subjects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


["rSurveyAssign: tools for simulation of assignment in web surveys"](vignette.html)で述べたように、
`rSurveyAssign`パッケージは以下の調査手続きを想定します。

1. ある人が調査に参加したとき、その対象者について、各カテゴリについて割付可能であるかどうかを調べる。
2. **なんらかの方法で**、その対象者をその人の割付可能カテゴリのうちいくつかへと割り付ける。
   もし割付できなかったら、その対象者に対する聴取は終了する。
3. 対象者に、それぞれの割付カテゴリについてスロットのリストを提示し、
   それぞれのスロットについて割付可能かどうかを調べる。
4. **なんらかの方法で**、その対象者を、いずれかの割付カテゴリの割付可能スロットのうちいくつかへと割り付ける。
   もし割付できなかったら、その対象者に対する聴取は中止する。
5. それぞれの割付スロットについて聴取する。
6. これを各対象者について繰り返す。すべてのカテゴリがクローズドになったら、調査を終了する。

この文書では、上記のうち太字部分について説明します。すなわち、Step 2.におけるカテゴリの割付方法、ならびにStep 4.における
スロットの割付方法について説明します。

## 1. カテゴリの割付方法

割付カテゴリを決める方法は多様です。`rSurveyAssign`パッケージは、割付方法を次の4つの特徴によって整理します。

- 割付タイプ
- 絞り込み条件
- 順序付け条件
- 除外条件

順に説明します。
対象者に割り付けるカテゴリの最大数を$L$とします。

#### 割付タイプ
`rSurveyAssign`パッケージでは、割付タイプとして次の2種類を想定します。

- `adaptive`: 適応的方法
  - 各対象者について以下の手順でカテゴリ割付を行います。
  - Step 1.  **絞り込み**: 
    - その人の割付可能カテゴリのなかから、指定した条件
      (絞り込み条件)を満たすカテゴリを選ぶ。
  - Step 2.  **順序付け**: 
    - 選んだ候補のなかから、指定された優先順位(順序付け条件)に従って
      $L$個までのカテゴリを選ぶ。
  - Step 3.  **除外**:
    - 選ばれたカテゴリが所定の条件(除外条件)に該当する場合は、割付を中止する。
- `nonadaptive`: 非適応的方法
  - 各対象者について以下の手順で割り付けを行います。
  - Step 1. **順序付け**:
    - その対象者にとっての割付可能性を無視し、すべてのカテゴリのなかから、指定された優先順位(順序付け条件)に従って$L$個までのカテゴリを選ぶ。
  - Step 2. **絞り込み**: 
    - 抜き出されたカテゴリのなかから、指定した条件(絞り込み条件)に該当するカテゴリを選ぶ。
  - Step 3. **除外**: 
    - 選ばれたカテゴリが所定の条件(除外条件)に該当する場合は、割付を中止する。
     
ふたつの割付タイプは、絞り込みを先に行うか、順序付けを先に行うかという点が違います。

- 適応的な方法では、まず割付可能なカテゴリに絞り込み、それらのなかから優先順位の高い
  $L$個までのカテゴリを選びます。
  - これは非適応的方法に比べて効率の良いやり方です。
  - その反面、割付バイアスが生じます。割付可能なカテゴリが多い人ほど、ある割付可能カテゴリに
    割り付けられる確率が低くなるためです。
- 非適応的な方法では、まず割付可能性を無視して$L$個までのカテゴリを選んでしまい、
  それらを割付可能なカテゴリへと絞り込みます。
  - その結果、割付カテゴリが少なくなってしまったり、
    0個になってしまったりする対象者が出現し、その分だけ多くの調査対象者数を必要とします。
  - その反面、割付バイアスは生じにくくなります。
    ある対象者がある割付可能カテゴリに割り付けられるかどうかが、その対象者の
    他のカテゴリの割付可能性とは独立に決まっているためです。


#### 絞り込み条件
`rSurveyAssign`パッケージでは、絞り込みの条件として次の2種類を想定します。

  - `all`: その対象者の割付可能カテゴリを選ぶ。
    - このとき、割付カテゴリはクローズドでありうる点に注意してください。つまり、すでに十分な量の回答を収集しているカテゴリについても聴取する場合が生じます。いいかえれば、「無駄な」回答収集を行うことになります。
  - `open`: その対象者の割付可能カテゴリのうちオープンなカテゴリを選ぶ。
  
どちらを選んでも必要な調査対象者数は変わりませんが、対象者の回答負荷は`all`のほうが高く、割付バイアスは`open`のほうが強くなると考えられます。
  
#### 順序付け条件
`rSurveyAssign`パッケージでは、順序付けの条件として以下の4種類を想定します。

  - `random`: ランダムに並べる。
  - `openclosed`:   以下の順に並べる。(1)オープンなカテゴリ、ランダム順。
            (2)クローズドなカテゴリ、ランダム順。
  - `shortnum`:   その時点でオープンなスロット数が多いカテゴリから順に並べる。
  - `shortratio`: その時点でオープンなスロットが占める割合が大きいカテゴリから順に並べる。
  
{`shortratio`と`shortnum`}, `open`, `random`の順に、必要な調査対象者数が少なくなり、また
割付バイアスが強くなると考えられます。

#### 除外条件
`rSurveyAssign`パッケージでは、除外の条件として以下の2種類を想定します。

  - `none`: なし。
  - `allclosed`: 選ばれたカテゴリがすべてクローズドであったら、割付を中止する。
    
絞り込み条件が`open`であるとき、
選ばれたカテゴリはすでにオープンなカテゴリなので、除外条件は意味を持ちません。
絞り込み条件が`all`であるとき、除外条件として`allclosed`を指定すると、
「割付カテゴリのうち少なくともどれかひとつはオープンでなければならない」と指定したことになります。

#### 組み合わせ

`rSurveyAssign`パッケージは、上で述べた4つの特徴の組み合わせによって生じる
すべての割付方法をサポートしています。参考として、すべての組み合わせを下表に示します。

割り付けるカテゴリの最大数を$L$とします。

割付タイプ     絞り込み条件 順序づけ条件          除外条件           割付カテゴリの選び方
-------------- ------------ --------------------- --------------     --------------
`adaptive`     `all`        `random`              `none`             その対象者の割付可能カテゴリから$L$個までを等確率に選ぶ。
`adaptive`     `all`        `random`              `allclosed`        その対象者の割付可能カテゴリから$L$個までを等確率に選ぶ。選ばれたカテゴリのなかにオープンなカテゴリがなかったら割付しない。
`adaptive`     `all`        `openclosed`          `none`             その対象者の割付可能カテゴリのうちオープンなものから$L$個までを等確率に選ぶ。$L$個選べなかったら、その対象者の割付可能カテゴリのうちクローズドなものから不足個数までを等確率に選ぶ。
`adaptive`     `all`        `openclosed`          `allclosed`        その対象者の割付可能カテゴリのうちオープンなものから$L$個までを等確率に選ぶ。$L$個選べなかったら、その対象者の割付可能カテゴリのうちクローズドなものから不足個数までを等確率に選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
`adaptive`     `all`        `shortnum`            `none`             その対象者の割付可能カテゴリから、オープンなスロットが多い順に$L$個までを選ぶ。
`adaptive`     `all`        `shortnum`            `allclosed`        その対象者の割付可能カテゴリから、オープンなスロットが多い順に$L$個までを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
`adaptive`     `all`        `shortratio`          `none`             その対象者の割付可能カテゴリのうち、オープンなスロットが占める割合が高い順に$L$個までを選ぶ。
`adaptive`     `all`        `shortratio`          `allclosed`        その対象者の割付可能カテゴリのうち、オープンなスロットが占める割合が高い順に$L$個までを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
`adaptive`     `open`       `random`,`openclosed` `none`,`allclosed` その対象者のオープンな割付可能カテゴリから$L$個までを等確率に選ぶ。
`adaptive`     `open`       `shortnum`            `none`,`allclosed` その対象者のオープンな割付可能カテゴリから、オープンなスロットが多い順に$L$個までを選ぶ。
`adaptive`     `open`       `shortratio`          `none`,`allclosed` その対象者のオープンな割付可能カテゴリから、オープンなスロットが占める割合が高い順に$L$個までを選ぶ。
`nonadaptive`  `all`        `random`              `none`             すべてのカテゴリから$L$個を等確率に抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
`nonadaptive`  `all`        `random`              `allclosed`        すべてのカテゴリから$L$個を等確率に抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリのなかにオープンなカテゴリがなかったら割付しない。
`nonadaptive`  `all`        `openclosed`          `none`             オープンなカテゴリから$L$個までを等確率に抜き出す。$L$個抜き出せなかったら、クローズドなカテゴリから不足個数までを等確率に抜き出す。抜き出したカテゴリのなかからその対象者の割付可能カテゴリを選ぶ。
`nonadaptive`  `all`        `openclosed`          `allclosed`        オープンなカテゴリから$L$個までを等確率に抜き出す。$L$個抜き出せなかったら、クローズドなカテゴリから不足個数までを等確率に抜き出す。抜き出したカテゴリのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
`nonadaptive`  `all`        `shortnum`            `none`             すべてのカテゴリから、オープンなスロットが多い順に$L$個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
`nonadaptive`  `all`        `shortnum`            `allclosed`        すべてのカテゴリから、オープンなスロットが多い順に$L$個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリのなかにオープンなカテゴリがなかったら割付しない。
`nonadaptive`  `all`        `shortratio`          `none`             すべてのカテゴリから、オープンなスロットが占める割合が高い順に$L$個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
`nonadaptive`  `all`        `shortratio`          `allclosed`        すべてのカテゴリから、オープンなスロットが占める割合が高い順に$L$個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
`nonadaptive`  `open`       `random`,`openclosed` `none`,`allclosed` オープンなカテゴリから$L$個までを等確率に抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
`nonadaptive`  `open`       `shortnum`            `none`,`allclosed` オープンなカテゴリからオープンなスロットが多い順に$L$個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
`nonadaptive`  `open`       `shortratio`          `none`,`allclosed` オープンなカテゴリからオープンなスロットが占める割合が高い順に$L$個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。

## 2. スロットの割付方法

**Step 4.**で割付スロットを決める方法は、割付カテゴリを決める場合と同様です。
説明を以下のように読み替えてください。

- 「カテゴリ」→「スロット」
- 「その時点でオープンなスロット数が多いカテゴリ」→「その時点で目標票数に対して不足している票数が多いスロット」
- 「その時点でオープンなスロットが占める割合が多いカテゴリ」→「その時点で目標票数に対して不足している票数の割合が高いスロット」

## 3. 割付スロット決定に際してのカテゴリの決定方法

**Step 4.**で割付スロットを決める際、もし**Step 2.**で複数個のカテゴリへの割付が生じていたら、
割付スロットをどの割付カテゴリから選ぶかという問題が生じます。

現バージョンの`rSurveyAssign`パッケージは、以下に述べる方法のみを想定しています。

- 割付カテゴリのなかからひとつを等確率に選び、そのカテゴリにおいて、前項で説明した方法でスロットへと割り付ける。
- スロット割付ができなかったら、他の割付カテゴリのなかからひとつを等確率に選び、そのカテゴリにおいてスロットへと割り付ける。これを繰り返し、どこかのカテゴリでスロット割付ができるまで続ける。
- どの割付カテゴリでもスロット割付ができなかったら、その対象者に対する調査を中止する。

ある対象者の割付スロットは、必ず同一カテゴリのスロットとなります。

