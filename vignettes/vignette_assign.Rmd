---
title: "How to assign subjects"
author: "Shigeru ONO"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{How to assign subjects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


["rSurveyAssign: tools for simulation of assignment in web surveys"](vignette.html)で述べたように、
`rSurveyAssign`パッケージは以下の調査手続きを想定します。

1. ある人が調査に参加したとき、その人について、各カテゴリについて割付可能であるかどうかを調べる。
2. **なんらかの方法で**、その対象者のすべての割付可能カテゴリのうちいくつかを選ぶ。
   これを、「対象者をカテゴリに割り付ける」と呼び、
  選択されたカテゴリを「割付カテゴリ」と呼ぶ。もし割付できなかったら、その対象者に
  対する調査は中止する。
3. 対象者に、それぞれの割付カテゴリについて、スロットのリストを提示し、
   それぞれについて割付可能かどうかを調べる。
4. **なんらかの方法で**、その対象者のいずれかの割付カテゴリの割付可能スロットのなかからいくつかを選ぶ。
   これを、「対象者をスロットに割り付ける」と表現し、
   選択されたカテゴリを「割付スロット」と呼ぶ。もし割付できなかったら、
   その対象者に対する調査は中止する。
5. 割付スロットについての詳細な設問を提示し、回答を得る。
6. すべてのカテゴリがクローズドになったら、調査を終了する。

この文書では、上記のStep 2.におけるカテゴリの割付方法、ならびにStep 4.における
スロットの割付方法について説明します。

## 1. カテゴリの割付方法

割付カテゴリを決める方法は、次の4つの特徴によって整理することができます。

- 割付タイプ
- 絞り込み条件
- 順序付け条件
- 除外条件

順に説明します。
以下では、割り付けるカテゴリの最大数をJとします。

#### 割付タイプ
次の2種類を想定します。

- adaptive: 適応的方法
  - 各対象者について以下の手順で割り付けを行います。
    -  **絞り込み**: 
      その人の割付可能カテゴリのなかから、指定した条件
      (絞り込み条件)を満たすカテゴリを選び、割付カテゴリの候補とする。
    -  **順序付け**: 選ばれた候補のなかから、指定された優先順位(順序付け条件)に従って
      J個までのカテゴリを抜き出し、割付カテゴリとする。
    -  **除外**: 割付カテゴリが所定の条件(除外条件)に該当する場合は、割付を中止する。
  - 適応的方法では、必要とする調査対象者数がより少なくなります。
  - その反面、回答には割付バイアスが生じます。
    なぜなら、ある対象者がある割付可能カテゴリを持っているとき、
    その対象者がそのカテゴリに割り付けられるかどうかが、その対象者の
    他のカテゴリについての割付可能性に応じて決まってしまうからです。
- nonadaptive: 非適応的方法
  - 各対象者について以下の手順で割り付けを行います。
    - **順序付け**: その対象者にとっての割付可能性は無視し、
      すべてのカテゴリのなかから、指定された優先順位(順序付け条件)に従って
      J数までのカテゴリを抜き出し、割付カテゴリの候補とする。
    - **絞り込み**: 抜き出されたカテゴリのなかから、
      指定した条件(絞り込み条件)に該当するカテゴリを選び、
      割付カテゴリとする。
    - **除外**: 割付カテゴリが所定の条件(除外条件)に該当する場合は、割付を中止する。
  - 非適応的割付は、多くの調査対象者数を必要とします。なぜなら、
    絞り込みの結果、割付カテゴリが0個になってしまう対象者が多いからです。
  - その反面、回答において割付バイアスは生じにくくなります。
    ある対象者がある割付可能カテゴリに割り付けられるかどうかが、その対象者の
    他のカテゴリの割付可能性とは独立に決まっているからです。

#### 絞り込み条件
次の2種類を想定します。

  - all: その対象者の割付可能カテゴリを選ぶ。
    - このとき、割付カテゴリはクローズドでありうる点に注意してください。すでに目標票数に達しているカテゴリについても聴取することになります。いいかえれば、「無駄な」回答収集を行うことになります。
  - open: その対象者の割付可能カテゴリのうちオープンなカテゴリを選ぶ。
  
#### ランキング条件
以下の4種類を想定します。

  - random: ランダムに並べる。
  - openclosed:   以下の順に並べる。(1)オープンなカテゴリ、ランダム順。
            (2)クローズドなカテゴリ、ランダム順。
  - shortnum:   その時点でオープンなスロット数が多いカテゴリから順に並べる。
  - shortratio: その時点でオープンなスロットが占める割合が大きいカテゴリから順に並べる。
  
(shortratioとshortnum), open, randomの順に、必要な調査対象者数が少なくなり、また
割付バイアスが生じる場合には割付バイアスが強くなると考えられます。

#### 除外条件
以下の2種類を想定します。

  - none: なし。
  - allclosed: 割付カテゴリとして選ばれたカテゴリがすべてクローズドであったら、割付しない。
    - この方法では割付バイアスが生じることに注意してください。なぜなら、ある対象者において
    ある割付可能カテゴリが割付カテゴリとして選ばれたとき、その対象者が実際にそのカテゴリに
    割り付けられるかどうかが、その対象者の他のカテゴリについての割付可能性に応じて
    決まってしまうからです。

#### 組み合わせ

`rSurveyAssign`パッケージは、上で述べた4つの特徴の組み合わせによる
割付方法をサポートしています。参考として、すべての組み合わせを下表に示します。

割り付けるカテゴリの最大数をJとします。

割付タイプ      絞り込み条件 順序づけ条件      除外条件       割付カテゴリの選び方
--------------- ------------ ----------------- -------------- --------------
adaptive        all          random            none           その対象者の割付可能カテゴリからJ個までを等確率に選ぶ。
adaptive        all          random            allclosed      その対象者の割付可能カテゴリからJ個までを等確率に選ぶ。選ばれたカテゴリのなかにオープンなカテゴリがなかったら割付しない。
adaptive        all          openclosed        none           その対象者の割付可能カテゴリのうちオープンなものからJ個までを等確率に選ぶ。J個選べなかったら、その対象者の割付可能カテゴリのうちクローズドなものから不足個数までを等確率に選ぶ。
adaptive        all          openclosed        allclosed      その対象者の割付可能カテゴリのうちオープンなものからJ個までを等確率に選ぶ。J個選べなかったら、その対象者の割付可能カテゴリのうちクローズドなものから不足個数までを等確率に選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
adaptive        all          shortnum          none           その対象者の割付可能カテゴリから、オープンなスロットが多い順にJ個までを選ぶ。
adaptive        all          shortnum          allclosed      その対象者の割付可能カテゴリから、オープンなスロットが多い順にJ個までを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
adaptive        all          shortratio        none           その対象者の割付可能カテゴリのうち、オープンなスロットが占める割合が高い順にJ個までを選ぶ。
adaptive        all          shortratio        allclosed      その対象者の割付可能カテゴリのうち、オープンなスロットが占める割合が高い順にJ個までを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
adaptive        open         random,openclosed none,allclosed その対象者のオープンな割付可能カテゴリからJ個までを等確率に選ぶ。
adaptive        open         shortnum          none,allclosed その対象者のオープンな割付可能カテゴリから、オープンなスロットが多い順にJ個までを選ぶ。
adaptive        open         shortratio        none,allclosed その対象者のオープンな割付可能カテゴリから、オープンなスロットが占める割合が高い順にJ個までを選ぶ。
nonadaptive     all          random            none           すべてのカテゴリからJ個を等確率に抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
nonadaptive     all          random            allclosed      すべてのカテゴリからJ個を等確率に抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリのなかにオープンなカテゴリがなかったら割付しない。
nonadaptive     all          openclosed        none           オープンなカテゴリからJ個までを等確率に抜き出す。J個抜き出せなかったら、クローズドなカテゴリから不足個数までを等確率に抜き出す。抜き出したカテゴリのなかからその対象者の割付可能カテゴリを選ぶ。
nonadaptive     all          openclosed        allclosed      オープンなカテゴリからJ個までを等確率に抜き出す。J個抜き出せなかったら、クローズドなカテゴリから不足個数までを等確率に抜き出す。抜き出したカテゴリのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
nonadaptive     all          shortnum          none           すべてのカテゴリから、オープンなスロットが多い順にJ個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
nonadaptive     all          shortnum          allclosed      すべてのカテゴリから、オープンなスロットが多い順にJ個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリのなかにオープンなカテゴリがなかったら割付しない。
nonadaptive     all          shortratio        none           すべてのカテゴリから、オープンなスロットが占める割合が高い順にJ個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
nonadaptive     all          shortratio        allclosed      すべてのカテゴリから、オープンなスロットが占める割合が高い順にJ個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。選ばれたカテゴリの中にオープンなカテゴリがなかったら割付しない。
nonadaptive     open         random,openclosed none,allclosed オープンなカテゴリからJ個までを等確率に抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
nonadaptive     open         shortnum          none,allclosed オープンなカテゴリからオープンなスロットが多い順にJ個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。
nonadaptive     open         shortratio        none,allclosed オープンなカテゴリからオープンなスロットが占める割合が高い順にJ個までを抜き出し、そのなかからその対象者の割付可能カテゴリを選ぶ。

## 2. スロットの割付方法

**Step 4.**で割付スロットを決める方法は、割付カテゴリを決める場合と同様です。
説明を以下のように読み替えてください。

- 「カテゴリ」→「スロット」
- 「その時点でオープンなスロット数が多いカテゴリ」→「その時点で目標票数に対して不足している票数が多いスロット」
- 「その時点でオープンなスロットが占める割合が多いカテゴリ」→「その時点で目標票数に対して不足している票数の割合が高いスロット」

## 3. 割付スロット決定に際してのカテゴリの決定方法

**Step 4.**で割付スロットを決める際、もし**Step 2.**で複数個のカテゴリへの割付が生じていたら、
割付スロットをどの割付カテゴリから選ぶかという問題が生じます。

現バージョンの`rSurveyAssign`パッケージは、以下に述べる方法のみを想定しています。

- 割付カテゴリのなかからひとつを等確率に選び、そのカテゴリの割付可能スロットのなかから、前項で説明した方法で割付スロットを選ぶ。
- 割付スロットの選択が行われなかった場合(ひとつも選べなかった場合、ないし除外条件によって中止された場合)は、他の割付カテゴリのなかからひとつを等確率に選び、そのカテゴリの割付可能スロットのなかから、前項で説明した方法で割付スロットを選ぶ。これを繰り返し、どこかのカテゴリから割付スロットを選ぶことができるまで続ける。
- どの割付カテゴリからも割付スロットが選ばれなかった場合は、その対象者に対する調査を中止する。

ある対象者への割付スロットは必ず同一カテゴリのスロットとなる点に注意してください。

複数個のカテゴリへの割付を行う場合、スロットへの回答には割付バイアスが生じます。
なぜなら、対象者がある割付可能スロットに対して
割り付けられるかどうかが、他のカテゴリのスロットの割付可能性に応じて決まるからです。


## 4. 割付に伴うバイアスはいつ生じるか

カテゴリについての回答において割付バイアスが**生じない**のは、割付方法が以下の条件を満たすときに限られます。他の方法ではなんらかのバイアスが生じることになります。

- カテゴリ割付において非適応的方法を選んでいるか、割付カテゴリの最大数が十分に大きく、すべての割付可能カテゴリへの割付が生じている
- カテゴリ割付において除外条件をnoneにしている

スロットについての回答において割付バイアスが**生じない**のは、割付方法が以下の条件を満たすときに限られます。他の方法ではなんらかのバイアスが生じることになります。

- カテゴリ割付において非適応的方法を選んでいる
- カテゴリ割付において除外条件をnoneにしている
- 割付カテゴリの最大数を1にしている
- スロット割付において非適応的方法を選んでいるか、割付スロットの最大数が十分に大きく、すべての割付可能スロットへの割付が生じている
- スロット割付において除外条件をnoneにしている

